# 腾讯云部署完整指南

## 📋 部署前准备

### 1. 需要准备的内容

- ✅ 腾讯云账号（已实名认证）
- ✅ Supabase 数据库连接字符串
- ✅ 腾讯云 COS 配置（Secret ID、Secret Key、Bucket）
- ✅ 各种 API Key（302.ai、Nano Banana等）
- ✅ 域名（可选，但推荐）

---

## 🖥️ 第一步：购买和配置服务器

### 1.1 购买云服务器

1. 登录 [腾讯云控制台](https://console.cloud.tencent.com/)
2. 进入 **云服务器 CVM** → **新建实例**
3. 选择配置：
   - **地域**：选择离用户最近的地域（如：广州、北京）
   - **实例类型**：标准型 S5
   - **CPU/内存**：
     - **初期（<1000用户）**：2核4G（约 ¥100-150/月）
     - **成长期（1000-10000用户）**：4核8G（约 ¥200-300/月）
   - **系统盘**：50GB SSD云硬盘
   - **网络**：默认VPC，带宽选择 5Mbps（按量计费或包年包月）
   - **操作系统**：Ubuntu 22.04 LTS（推荐）或 CentOS 7.9
   - **安全组**：开放端口 22（SSH）、80（HTTP）、443（HTTPS）、3002（后端API，可选）

4. 设置登录方式：
   - **密码登录**：设置 root 密码（记住这个密码！）
   - **SSH密钥**：如果有密钥，可以选择密钥登录（更安全）

5. 点击 **立即购买** 并完成支付

### 1.2 连接到服务器

**Windows 用户：**
```bash
# 使用 PowerShell 或 CMD
ssh root@你的服务器IP地址
```

**Mac/Linux 用户：**
```bash
ssh root@你的服务器IP地址
```

输入密码后即可登录。

---

## 🔧 第二步：安装必要软件

### 2.1 更新系统

```bash
# Ubuntu
apt update && apt upgrade -y

# CentOS
yum update -y
```

### 2.2 安装 Node.js（使用 NVM 推荐）

```bash
# 安装 NVM
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash

# 重新加载 shell 配置
source ~/.bashrc

# 安装 Node.js 20 LTS
nvm install 20
nvm use 20
nvm alias default 20

# 验证安装
node -v  # 应该显示 v20.x.x
npm -v   # 应该显示 10.x.x
```

### 2.3 安装 PM2（进程管理）

```bash
npm install -g pm2

# 设置 PM2 开机自启
pm2 startup
# 按照提示执行生成的命令
```

### 2.4 安装 Nginx（反向代理）

```bash
# Ubuntu
apt install nginx -y

# CentOS
yum install nginx -y

# 启动 Nginx
systemctl start nginx
systemctl enable nginx

# 验证 Nginx 是否运行
systemctl status nginx
```

### 2.5 安装 Git

```bash
# Ubuntu
apt install git -y

# CentOS
yum install git -y
```

---

## 📦 第三步：部署代码

### 3.1 克隆代码仓库

```bash
# 创建项目目录
mkdir -p /var/www/aigc-agent
cd /var/www/aigc-agent

# 克隆代码（替换为你的仓库地址）
git clone https://github.com/你的用户名/AIGC-jubianage-agent.git .

# 或者如果代码在本地，可以使用 scp 上传
# Windows PowerShell:
# scp -r C:\Users\Administrator\Desktop\AIGC-jubianage-agent root@你的服务器IP:/var/www/aigc-agent
```

### 3.2 安装依赖

```bash
# 安装前端依赖
cd /var/www/aigc-agent
npm install

# 安装后端依赖
cd /var/www/aigc-agent/server
npm install
```

### 3.3 构建前端

```bash
cd /var/www/aigc-agent
npm run build
```

构建完成后，前端文件会在 `dist` 目录中。

---

## ⚙️ 第四步：配置环境变量

### 4.1 创建环境变量文件

```bash
cd /var/www/aigc-agent/server
cp env.example .env
nano .env  # 或使用 vi .env
```

### 4.2 配置关键环境变量

编辑 `.env` 文件，配置以下内容：

```env
# 服务器端口
PORT=3002

# Supabase 数据库连接字符串
DATABASE_URL=postgresql://postgres.项目ID:密码@aws-1-ap-south-1.pooler.supabase.com:5432/postgres

# JWT 密钥（生成一个随机字符串）
JWT_SECRET=你的随机JWT密钥（至少32个字符）

# 腾讯云 COS 配置
COS_SECRET_ID=你的COS_SECRET_ID
COS_SECRET_KEY=你的COS_SECRET_KEY
COS_REGION=ap-guangzhou
COS_BUCKET=你的bucket名称

# 各种 API Key（根据你的需要配置）
NANO_BANANA_API_KEY=你的API_KEY
MIDJOURNEY_API_KEY=你的API_KEY
FLUX_2_MAX_API_KEY=你的API_KEY
# ... 其他 API Key

# 前端 API 基础 URL（部署后改为你的域名）
# 例如：https://api.yourdomain.com 或 https://yourdomain.com/api
```

**重要提示：**
- `JWT_SECRET` 可以使用以下命令生成：
  ```bash
  node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
  ```
- `DATABASE_URL` 从 Supabase 项目设置中获取
- 保存文件：`Ctrl+O` → `Enter` → `Ctrl+X`（nano编辑器）

### 4.3 验证环境变量

```bash
cd /var/www/aigc-agent/server
npm run check-env
```

---

## 🗄️ 第五步：配置数据库

### 5.1 确保 Supabase 数据库已配置

数据库表应该已经通过 Supabase MCP 工具创建。如果需要手动创建，可以：

1. 登录 Supabase Dashboard
2. 进入 SQL Editor
3. 执行 `server/db/create_tables_for_supabase.sql` 中的 SQL

### 5.2 测试数据库连接

```bash
cd /var/www/aigc-agent/server
node db/testSupabaseConnection.js
```

---

## 🚀 第六步：启动后端服务

### 6.1 使用 PM2 启动后端

```bash
cd /var/www/aigc-agent/server
pm2 start index.js --name aigc-backend

# 查看状态
pm2 status

# 查看日志
pm2 logs aigc-backend

# 保存 PM2 配置（开机自启）
pm2 save
```

### 6.2 验证后端运行

```bash
# 检查端口是否监听
netstat -tlnp | grep 3002

# 或者使用 curl 测试
curl http://localhost:3002/api/health
```

---

## 🌐 第七步：配置 Nginx 反向代理

### 7.1 创建 Nginx 配置文件

```bash
nano /etc/nginx/sites-available/aigc-agent
```

**Ubuntu 使用：**
```nginx
server {
    listen 80;
    server_name yourdomain.com www.yourdomain.com;  # 替换为你的域名

    # 前端静态文件
    location / {
        root /var/www/aigc-agent/dist;
        try_files $uri $uri/ /index.html;
        index index.html;
    }

    # 后端 API 代理
    location /api {
        proxy_pass http://localhost:3002;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    # WebSocket 支持（如果需要）
    location /ws {
        proxy_pass http://localhost:3002;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
```

**CentOS 使用：**
```bash
nano /etc/nginx/conf.d/aigc-agent.conf
```
（内容同上）

### 7.2 启用配置

**Ubuntu：**
```bash
ln -s /etc/nginx/sites-available/aigc-agent /etc/nginx/sites-enabled/
nginx -t  # 测试配置
systemctl reload nginx
```

**CentOS：**
```bash
nginx -t  # 测试配置
systemctl reload nginx
```

### 7.3 如果没有域名

如果没有域名，可以暂时使用 IP 地址：

```nginx
server {
    listen 80;
    server_name 你的服务器IP地址;  # 例如：123.456.789.0

    # ... 其他配置同上
}
```

---

## 🔒 第八步：配置 SSL 证书（HTTPS）

### 8.1 使用 Let's Encrypt 免费证书

```bash
# 安装 Certbot
apt install certbot python3-certbot-nginx -y  # Ubuntu
# 或
yum install certbot python3-certbot-nginx -y  # CentOS

# 获取证书（替换为你的域名和邮箱）
certbot --nginx -d yourdomain.com -d www.yourdomain.com --email your@email.com --agree-tos --non-interactive

# 自动续期（已自动配置）
certbot renew --dry-run
```

### 8.2 验证 HTTPS

访问 `https://yourdomain.com`，应该能看到绿色锁图标。

---

## 🔄 第九步：配置自动部署（可选）

### 9.1 使用 GitHub Actions

创建 `.github/workflows/deploy.yml`：

```yaml
name: Deploy to Tencent Cloud

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Deploy to server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /var/www/aigc-agent
            git pull origin main
            npm install
            npm run build
            cd server
            npm install
            pm2 restart aigc-backend
```

### 9.2 手动部署脚本

创建 `deploy.sh`：

```bash
#!/bin/bash
cd /var/www/aigc-agent
git pull origin main
npm install
npm run build
cd server
npm install
pm2 restart aigc-backend
echo "部署完成！"
```

使用：
```bash
chmod +x deploy.sh
./deploy.sh
```

---

## 📊 第十步：监控和维护

### 10.1 PM2 监控

```bash
# 查看所有进程
pm2 list

# 查看日志
pm2 logs aigc-backend

# 查看资源使用
pm2 monit

# 重启服务
pm2 restart aigc-backend

# 停止服务
pm2 stop aigc-backend
```

### 10.2 系统监控

```bash
# 查看系统资源
htop  # 需要安装：apt install htop

# 查看磁盘使用
df -h

# 查看内存使用
free -h
```

### 10.3 日志查看

```bash
# Nginx 日志
tail -f /var/log/nginx/access.log
tail -f /var/log/nginx/error.log

# PM2 日志
pm2 logs aigc-backend
```

---

## 🐛 常见问题排查

### 问题1：无法访问网站

**检查：**
```bash
# 检查 Nginx 状态
systemctl status nginx

# 检查后端服务
pm2 status

# 检查端口
netstat -tlnp | grep 80
netstat -tlnp | grep 3002

# 检查防火墙
ufw status  # Ubuntu
firewall-cmd --list-all  # CentOS
```

### 问题2：后端服务无法启动

**检查：**
```bash
# 查看 PM2 日志
pm2 logs aigc-backend --lines 100

# 检查环境变量
cd /var/www/aigc-agent/server
cat .env

# 手动启动测试
cd /var/www/aigc-agent/server
node index.js
```

### 问题3：数据库连接失败

**检查：**
```bash
# 测试数据库连接
cd /var/www/aigc-agent/server
node db/testSupabaseConnection.js

# 检查环境变量中的 DATABASE_URL
grep DATABASE_URL .env
```

### 问题4：前端无法加载

**检查：**
```bash
# 检查构建文件
ls -la /var/www/aigc-agent/dist

# 检查 Nginx 配置
nginx -t

# 检查文件权限
chown -R www-data:www-data /var/www/aigc-agent/dist
```

---

## 📝 部署检查清单

- [ ] 服务器已购买并配置
- [ ] Node.js 已安装（v20+）
- [ ] PM2 已安装并配置
- [ ] Nginx 已安装并配置
- [ ] 代码已克隆到服务器
- [ ] 依赖已安装（前端和后端）
- [ ] 前端已构建
- [ ] 环境变量已配置（.env）
- [ ] 数据库连接正常
- [ ] 后端服务已启动（PM2）
- [ ] Nginx 反向代理已配置
- [ ] SSL 证书已配置（HTTPS）
- [ ] 域名已解析到服务器 IP
- [ ] 防火墙端口已开放
- [ ] 测试访问正常

---

## 🎯 下一步优化

### 1. 配置 CDN 加速

使用腾讯云 CDN 加速静态资源：
1. 登录腾讯云控制台
2. 进入 CDN 控制台
3. 添加域名
4. 配置源站为你的服务器
5. 更新前端代码中的资源路径

### 2. 配置数据库备份

Supabase 自动备份，但建议：
- 定期导出数据
- 配置自动备份策略

### 3. 配置监控告警

- 使用腾讯云监控
- 配置 CPU、内存、磁盘告警
- 配置服务可用性监控

### 4. 性能优化

- 启用 Nginx 缓存
- 配置 Gzip 压缩
- 优化数据库查询
- 使用 Redis 缓存（可选）

---

## 📞 需要帮助？

如果遇到问题，可以：
1. 查看日志文件
2. 检查环境变量配置
3. 验证网络连接
4. 查看腾讯云文档

**祝部署顺利！** 🚀

