# è…¾è®¯äº‘éƒ¨ç½²å¿«é€Ÿå¼€å§‹

## ğŸš€ 5åˆ†é’Ÿå¿«é€Ÿéƒ¨ç½²

### å‰ç½®æ¡ä»¶

- âœ… å·²è´­ä¹°è…¾è®¯äº‘æœåŠ¡å™¨ï¼ˆUbuntu 22.04 æˆ– CentOS 7.9ï¼‰
- âœ… å·²è·å–æœåŠ¡å™¨ IP å’Œ root å¯†ç 
- âœ… å·²é…ç½® Supabase æ•°æ®åº“
- âœ… å·²é…ç½®è…¾è®¯äº‘ COS

---

## æ­¥éª¤1ï¼šè¿æ¥æœåŠ¡å™¨

```bash
ssh root@ä½ çš„æœåŠ¡å™¨IP
```

---

## æ­¥éª¤2ï¼šä¸€é”®å®‰è£…ç¯å¢ƒ

```bash
# æ›´æ–°ç³»ç»Ÿ
apt update && apt upgrade -y  # Ubuntu
# æˆ–
yum update -y  # CentOS

# å®‰è£… Node.jsï¼ˆä½¿ç”¨ NVMï¼‰
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
source ~/.bashrc
nvm install 20
nvm use 20
nvm alias default 20

# å®‰è£… PM2
npm install -g pm2
pm2 startup

# å®‰è£… Nginx
apt install nginx -y  # Ubuntu
# æˆ–
yum install nginx -y  # CentOS
systemctl start nginx
systemctl enable nginx

# å®‰è£… Git
apt install git -y  # Ubuntu
# æˆ–
yum install git -y  # CentOS
```

---

## æ­¥éª¤3ï¼šéƒ¨ç½²ä»£ç 

```bash
# åˆ›å»ºé¡¹ç›®ç›®å½•
mkdir -p /var/www/aigc-agent
cd /var/www/aigc-agent

# å…‹éš†ä»£ç ï¼ˆæ›¿æ¢ä¸ºä½ çš„ä»“åº“åœ°å€ï¼‰
git clone https://github.com/ä½ çš„ç”¨æˆ·å/AIGC-jubianage-agent.git .

# æˆ–è€…ä½¿ç”¨ scp ä¸Šä¼ æœ¬åœ°ä»£ç 
# Windows PowerShell:
# scp -r C:\Users\Administrator\Desktop\AIGC-jubianage-agent root@ä½ çš„æœåŠ¡å™¨IP:/var/www/aigc-agent
```

---

## æ­¥éª¤4ï¼šé…ç½®ç¯å¢ƒå˜é‡

```bash
cd /var/www/aigc-agent/server
cp env.example .env
nano .env
```

**å¿…é¡»é…ç½®çš„é¡¹ï¼š**
```env
PORT=3002
DATABASE_URL=ä½ çš„Supabaseè¿æ¥å­—ç¬¦ä¸²
JWT_SECRET=ä½ çš„JWTå¯†é’¥ï¼ˆè‡³å°‘32å­—ç¬¦ï¼‰
COS_SECRET_ID=ä½ çš„COS Secret ID
COS_SECRET_KEY=ä½ çš„COS Secret Key
COS_REGION=ap-guangzhou
COS_BUCKET=ä½ çš„bucketåç§°
```

**ç”Ÿæˆ JWT_SECRETï¼š**
```bash
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
```

---

## æ­¥éª¤5ï¼šå®‰è£…ä¾èµ–å¹¶æ„å»º

```bash
cd /var/www/aigc-agent

# å®‰è£…å‰ç«¯ä¾èµ–
npm install

# æ„å»ºå‰ç«¯
npm run build

# å®‰è£…åç«¯ä¾èµ–
cd server
npm install
```

---

## æ­¥éª¤6ï¼šé…ç½®å‰ç«¯ API URL

åˆ›å»º `.env.production` æ–‡ä»¶ï¼š

```bash
cd /var/www/aigc-agent
nano .env.production
```

å†…å®¹ï¼š
```env
# å¦‚æœä½¿ç”¨åŸŸå
VITE_API_BASE_URL=https://yourdomain.com/api

# å¦‚æœä½¿ç”¨ IPï¼ˆä¸´æ—¶ï¼‰
VITE_API_BASE_URL=http://ä½ çš„æœåŠ¡å™¨IP:3002
```

**é‡è¦ï¼š** å¦‚æœä½¿ç”¨ Nginx åå‘ä»£ç†ï¼ŒAPI URL åº”è¯¥æ˜¯ `/api`ï¼ˆç›¸å¯¹è·¯å¾„ï¼‰

é‡æ–°æ„å»ºï¼š
```bash
npm run build
```

---

## æ­¥éª¤7ï¼šå¯åŠ¨åç«¯æœåŠ¡

```bash
cd /var/www/aigc-agent/server
pm2 start index.js --name aigc-backend
pm2 save
```

æŸ¥çœ‹çŠ¶æ€ï¼š
```bash
pm2 status
pm2 logs aigc-backend
```

---

## æ­¥éª¤8ï¼šé…ç½® Nginx

```bash
nano /etc/nginx/sites-available/aigc-agent
```

**Ubuntuï¼š**
```nginx
server {
    listen 80;
    server_name ä½ çš„åŸŸåæˆ–IP;

    # å‰ç«¯
    location / {
        root /var/www/aigc-agent/dist;
        try_files $uri $uri/ /index.html;
    }

    # åç«¯ API
    location /api {
        proxy_pass http://localhost:3002;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
```

å¯ç”¨é…ç½®ï¼š
```bash
# Ubuntu
ln -s /etc/nginx/sites-available/aigc-agent /etc/nginx/sites-enabled/
nginx -t
systemctl reload nginx

# CentOS
nginx -t
systemctl reload nginx
```

---

## æ­¥éª¤9ï¼šé…ç½® SSLï¼ˆå¯é€‰ä½†æ¨èï¼‰

```bash
# å®‰è£… Certbot
apt install certbot python3-certbot-nginx -y

# è·å–è¯ä¹¦ï¼ˆæ›¿æ¢ä¸ºä½ çš„åŸŸåå’Œé‚®ç®±ï¼‰
certbot --nginx -d yourdomain.com -d www.yourdomain.com --email your@email.com --agree-tos --non-interactive
```

---

## æ­¥éª¤10ï¼šæµ‹è¯•è®¿é—®

1. è®¿é—® `http://ä½ çš„æœåŠ¡å™¨IP` æˆ– `https://yourdomain.com`
2. åº”è¯¥èƒ½çœ‹åˆ°ç™»å½•é¡µé¢
3. æµ‹è¯•ç™»å½•åŠŸèƒ½

---

## ğŸ”„ æ›´æ–°éƒ¨ç½²

ä½¿ç”¨éƒ¨ç½²è„šæœ¬ï¼š

```bash
cd /var/www/aigc-agent
chmod +x deploy.sh
./deploy.sh
```

æˆ–æ‰‹åŠ¨æ›´æ–°ï¼š

```bash
cd /var/www/aigc-agent
git pull
npm install
npm run build
cd server
npm install
pm2 restart aigc-backend
```

---

## ğŸ› å¸¸è§é—®é¢˜

### æ— æ³•è®¿é—®ç½‘ç«™

```bash
# æ£€æŸ¥æœåŠ¡çŠ¶æ€
pm2 status
systemctl status nginx

# æ£€æŸ¥ç«¯å£
netstat -tlnp | grep 80
netstat -tlnp | grep 3002

# æ£€æŸ¥é˜²ç«å¢™
ufw status  # Ubuntu
# å¼€æ”¾ç«¯å£
ufw allow 80
ufw allow 443
```

### åç«¯æ— æ³•å¯åŠ¨

```bash
# æŸ¥çœ‹æ—¥å¿—
pm2 logs aigc-backend

# æ£€æŸ¥ç¯å¢ƒå˜é‡
cd /var/www/aigc-agent/server
cat .env

# æ‰‹åŠ¨æµ‹è¯•
node index.js
```

### æ•°æ®åº“è¿æ¥å¤±è´¥

```bash
# æµ‹è¯•è¿æ¥
cd /var/www/aigc-agent/server
node db/testSupabaseConnection.js

# æ£€æŸ¥ DATABASE_URL
grep DATABASE_URL .env
```

---

## ğŸ“ éœ€è¦å¸®åŠ©ï¼Ÿ

æŸ¥çœ‹å®Œæ•´éƒ¨ç½²æŒ‡å—ï¼š`docs/è…¾è®¯äº‘éƒ¨ç½²å®Œæ•´æŒ‡å—.md`

